---
/**
 * BusinessHoursBadge Component
 *
 * Displays the current business status of the real estate office:
 * - Open (green): During business hours
 * - Closing soon (amber/ocre): 30 minutes before closing
 * - Closed (gray): Outside business hours and Sundays
 *
 * Business Hours:
 * - Monday to Friday: 9:00 - 19:00
 * - Saturday: 10:00 - 14:00
 * - Sunday: Closed
 */
import { cn } from '@/lib/utils';

interface Props {
  /** Show expanded version with full schedule (for mobile menu) */
  expanded?: boolean;
  /** Additional CSS classes */
  class?: string;
}

const { expanded = false, class: className } = Astro.props;

// Schedule data for display
const scheduleData = [
  { days: 'Lunes a Viernes', hours: '9:00 - 19:00' },
  { days: 'Sabados', hours: '10:00 - 14:00' },
  { days: 'Domingos', hours: 'Cerrado' },
];
---

<div
  class={cn('business-hours-badge', className)}
  data-business-hours
  data-expanded={expanded ? 'true' : 'false'}
>
  {expanded ? (
    <!-- Expanded version for mobile menu -->
    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
      <div class="flex items-center gap-2 mb-3">
        <span
          class="status-indicator w-2.5 h-2.5 rounded-full bg-gray-400"
          data-status-indicator
          aria-hidden="true"
        ></span>
        <span
          class="status-text text-sm font-semibold text-gray-600"
          data-status-text
        >
          Cargando...
        </span>
      </div>
      <div class="space-y-1.5">
        {scheduleData.map((item) => (
          <div class="flex justify-between text-sm">
            <span class="text-gray-600">{item.days}</span>
            <span class="font-medium text-gray-700">{item.hours}</span>
          </div>
        ))}
      </div>
    </div>
  ) : (
    <!-- Compact version for desktop header with tooltip -->
    <div class="relative group">
      <button
        type="button"
        class={cn(
          'inline-flex items-center gap-2',
          'px-3 py-1.5',
          'bg-gray-100 rounded-full',
          'text-sm font-medium text-gray-600',
          'transition-colors',
          'hover:bg-gray-200',
          'focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2'
        )}
        aria-describedby="business-hours-tooltip"
      >
        <span
          class="status-indicator w-2 h-2 rounded-full bg-gray-400"
          data-status-indicator
          aria-hidden="true"
        ></span>
        <span class="status-text" data-status-text>Cargando...</span>
      </button>

      <!-- Tooltip with full schedule -->
      <div
        id="business-hours-tooltip"
        role="tooltip"
        class={cn(
          'absolute top-full left-1/2 -translate-x-1/2 mt-2',
          'w-56 p-3',
          'bg-gray-700 text-white rounded-lg shadow-lg',
          'opacity-0 invisible',
          'group-hover:opacity-100 group-hover:visible',
          'group-focus-within:opacity-100 group-focus-within:visible',
          'transition-all duration-200',
          'z-50'
        )}
      >
        <div class="text-xs font-semibold mb-2 text-gray-300">Horario de atencion</div>
        <div class="space-y-1">
          {scheduleData.map((item) => (
            <div class="flex justify-between text-sm">
              <span class="text-gray-300">{item.days}</span>
              <span class="font-medium text-white">{item.hours}</span>
            </div>
          ))}
        </div>
        <!-- Tooltip arrow -->
        <div class="absolute -top-1.5 left-1/2 -translate-x-1/2 w-3 h-3 bg-gray-700 rotate-45"></div>
      </div>
    </div>
  )}
</div>

<style>
  /* Pulsing animation for the status indicator when open */
  .status-indicator.is-open {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }

  @keyframes pulse {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }

  /* Respect reduced motion preferences */
  @media (prefers-reduced-motion: reduce) {
    .status-indicator.is-open {
      animation: none;
    }
  }
</style>

<script>
  /**
   * Business hours status calculator
   * Determines if the business is open, closing soon, or closed
   */

  interface BusinessStatus {
    status: 'open' | 'closing-soon' | 'closed';
    label: string;
  }

  interface DaySchedule {
    open: number; // Hour in 24h format
    close: number;
  }

  // Business hours schedule (0 = Sunday, 1 = Monday, etc.)
  const schedule: Record<number, DaySchedule | null> = {
    0: null, // Sunday - closed
    1: { open: 9, close: 19 }, // Monday
    2: { open: 9, close: 19 }, // Tuesday
    3: { open: 9, close: 19 }, // Wednesday
    4: { open: 9, close: 19 }, // Thursday
    5: { open: 9, close: 19 }, // Friday
    6: { open: 10, close: 14 }, // Saturday
  };

  function getBusinessStatus(now: Date = new Date()): BusinessStatus {
    const dayOfWeek = now.getDay();
    const currentHour = now.getHours();
    const currentMinutes = now.getMinutes();
    const currentTimeInMinutes = currentHour * 60 + currentMinutes;

    const todaySchedule = schedule[dayOfWeek];

    // Closed on Sundays or if no schedule defined
    if (!todaySchedule) {
      return { status: 'closed', label: 'Cerrado' };
    }

    const openTimeInMinutes = todaySchedule.open * 60;
    const closeTimeInMinutes = todaySchedule.close * 60;
    const closingSoonThreshold = closeTimeInMinutes - 30; // 30 minutes before closing

    // Before opening hours
    if (currentTimeInMinutes < openTimeInMinutes) {
      return { status: 'closed', label: 'Cerrado' };
    }

    // After closing hours
    if (currentTimeInMinutes >= closeTimeInMinutes) {
      return { status: 'closed', label: 'Cerrado' };
    }

    // Closing soon (within 30 minutes of closing)
    if (currentTimeInMinutes >= closingSoonThreshold) {
      return { status: 'closing-soon', label: 'Cierra pronto' };
    }

    // Open
    return { status: 'open', label: 'Abierto' };
  }

  function updateBadge(container: Element): void {
    const { status, label } = getBusinessStatus();

    const indicator = container.querySelector('[data-status-indicator]') as HTMLElement | null;
    const text = container.querySelector('[data-status-text]') as HTMLElement | null;

    if (!indicator || !text) return;

    // Update text
    text.textContent = label;

    // Remove previous status classes
    indicator.classList.remove('is-open', 'bg-secondary', 'bg-accent', 'bg-gray-400');

    // Apply status-specific styles
    switch (status) {
      case 'open':
        indicator.classList.add('is-open', 'bg-secondary');
        text.className = text.className.replace(/text-\w+-\d+/g, '');
        text.classList.add('text-secondary-dark');
        break;
      case 'closing-soon':
        indicator.classList.add('bg-accent');
        text.className = text.className.replace(/text-\w+-\d+/g, '');
        text.classList.add('text-accent-dark');
        break;
      case 'closed':
        indicator.classList.add('bg-gray-400');
        text.className = text.className.replace(/text-\w+-\d+/g, '');
        text.classList.add('text-gray-500');
        break;
    }
  }

  function initBusinessHoursBadge(): void {
    const badges = document.querySelectorAll('[data-business-hours]');
    badges.forEach((badge) => {
      updateBadge(badge);
    });

    // Update every minute
    setInterval(() => {
      badges.forEach((badge) => {
        updateBadge(badge);
      });
    }, 60000);
  }

  // Initialize on page load
  document.addEventListener('astro:page-load', initBusinessHoursBadge);

  // Also run on initial load for non-SPA navigation
  initBusinessHoursBadge();
</script>

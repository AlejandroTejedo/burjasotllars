---
/**
 * PropertyCard Component
 *
 * A reusable card component for displaying property listings.
 * The entire card is clickable and links to the property detail page.
 *
 * @example
 * <PropertyCard
 *   id="123"
 *   title="Ático con terraza en el centro"
 *   location="Burjassot, Valencia"
 *   price={285000}
 *   bedrooms={3}
 *   bathrooms={2}
 *   area={120}
 *   isNew={true}
 * />
 */

import type { HTMLAttributes } from 'astro/types';
import type { Property } from '@/types';
import { cn } from '@/lib/utils';
import Badge from '@/components/ui/Badge.astro';
import { MapPin, Bed, Bath, Maximize2 } from 'lucide-astro';

export interface Props extends Omit<Property, 'id'>, HTMLAttributes<'article'> {
  /** Unique identifier for the property (required for link generation) */
  id: string;
  /** Additional CSS classes */
  class?: string;
}

const {
  id,
  title,
  location,
  price,
  image,
  bedrooms,
  bathrooms,
  area,
  isNew = false,
  isFeatured = false,
  class: className,
  ...rest
} = Astro.props;

/**
 * Formats a price number to Spanish locale format with euro symbol
 * @param value - Price in euros
 * @returns Formatted price string (e.g., "285.000 €")
 */
function formatPrice(value: number): string {
  return new Intl.NumberFormat('es-ES', {
    style: 'decimal',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0,
  }).format(value) + ' €';
}

const propertyUrl = `/propiedades/${id}`;
const hasImage = image && image.length > 0;
const showBadge = isNew || isFeatured;
const badgeText = isNew ? 'Novedad' : 'Destacado';
const badgeVariant = isNew ? 'accent' : 'primary';

// Alt text for the image
const imageAlt = `Imagen de ${title} en ${location}`;
---

<article
  class={cn(
    'group relative',
    'bg-card border border-gray-200 rounded-lg',
    'overflow-hidden',
    'transition-all duration-300',
    'hover:shadow-md hover:border-gray-300',
    className
  )}
  {...rest}
>
  {/* Clickable overlay for the entire card */}
  <a
    href={propertyUrl}
    class="absolute inset-0 z-10"
    aria-label={`Ver detalles de ${title}`}
  >
    <span class="sr-only">Ver detalles de {title}</span>
  </a>

  {/* Image section */}
  <div class="relative aspect-[4/3] overflow-hidden bg-gray-100">
    {hasImage ? (
      <img
        src={image}
        alt={imageAlt}
        loading="lazy"
        decoding="async"
        class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
      />
    ) : (
      <div class="w-full h-full flex items-center justify-center bg-muted">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="w-16 h-16 text-gray-300"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="1.5"
            d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"
          />
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="1.5"
            d="M9 22V12h6v10"
          />
        </svg>
      </div>
    )}

    {/* Badge */}
    {showBadge && (
      <div class="absolute top-4 right-4 z-0">
        <Badge variant={badgeVariant} pill>
          {badgeText}
        </Badge>
      </div>
    )}
  </div>

  {/* Content section */}
  <div class="p-6 space-y-4">
    {/* Title */}
    <h3 class="text-xl font-semibold leading-snug text-gray-700 line-clamp-2 transition-colors duration-200 group-hover:text-primary">
      {title}
    </h3>

    {/* Location */}
    <div class="flex items-center gap-2 text-sm text-gray-500">
      <MapPin class="w-4 h-4 flex-shrink-0" aria-hidden="true" />
      <span class="truncate">{location}</span>
    </div>

    {/* Features */}
    {(bedrooms !== undefined || bathrooms !== undefined || area !== undefined) && (
      <div class="flex flex-wrap items-center gap-4 text-sm text-gray-500">
        {bedrooms !== undefined && (
          <span class="flex items-center gap-1">
            <Bed class="w-4 h-4" aria-hidden="true" />
            <span>{bedrooms} {bedrooms === 1 ? 'habitación' : 'habitaciones'}</span>
          </span>
        )}
        {bathrooms !== undefined && (
          <span class="flex items-center gap-1">
            <Bath class="w-4 h-4" aria-hidden="true" />
            <span>{bathrooms} {bathrooms === 1 ? 'baño' : 'baños'}</span>
          </span>
        )}
        {area !== undefined && (
          <span class="flex items-center gap-1">
            <Maximize2 class="w-4 h-4" aria-hidden="true" />
            <span>{area} m²</span>
          </span>
        )}
      </div>
    )}

    {/* Price */}
    <div class="pt-4 border-t border-gray-200">
      <p class="text-2xl font-bold text-primary">
        {formatPrice(price)}
      </p>
    </div>
  </div>
</article>
